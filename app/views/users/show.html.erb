<!DOCTYPE html>
<html>
  <head>
    <title>Photogram Final</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
  </head>

  <body>

    <h1><%= @this_user.username %></h1>
    <% if current_user && current_user != @this_user %>
      <% existing_request = current_user.follow_request_to(@this_user) %>

      <% if existing_request %>
        <%# A request exists (either pending or accepted) %>
        <% if existing_request.status == "pending" %>
          <p>Follow request sent.</p>
          <%# Optional: Form to cancel the pending request %>
          <%# This uses your existing manual route for deleting a follow request %>
          <%# Your route is GET /delete_follow_request/:path_id %>
          <form action="/delete_follow_request/<%= existing_request.id %>" method="get">
            <button type="submit">Cancel Request</button>
          </form>
        <% elsif existing_request.status == "accepted" %>
          <%# Current user is already following @this_user %>
          <%# This uses your existing manual route for deleting a follow request %>
          <%= link_to "Unfollow", 
            "/delete_follow_request/#{existing_request.id}", 
            method: :get, 
            data: { turbo_confirm: "Are you sure you want to unfollow?" } %>

        <% end %>
      <% else %>
        <%# No request exists, so current_user is not following and hasn't sent a request %>
        <%# This is where the "Follow" button should appear for your test %>
        <%# This uses your existing manual route for creating a follow request %>
        <form action="/insert_follow_request" method="post">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
          <%# The recipient_id is the ID of the user whose profile is being viewed %>
          <input type="hidden" name="recipient_id" value="<%= @this_user.id %>">
          <%# sender_id will be current_user.id, handled in the controller %>
          <button type="submit">Follow</button>
        </form>
      <% end %>
    <% end %>
    <dl>
      <dt>Private</dt>
      <dd><%= @this_user.private %></dd>

      <dt>Followers</dt>
      <dd><%= @this_user.followers.count %></dd>

      <% if current_user == @this_user %>
        <h4>Pending follow requests</h4>
        <ul>
          <% @this_user.follow_received.where(status: "pending").each do |request| %>

            <li>
              <%= request.sender.username %>

              <form action="/modify_follow_request/<%= request.id %>" method="post">
                <input type="hidden" name="query_status" value="accepted">
                <button>Accept</button>
              </form>

              <form action="/modify_follow_request/<%= request.id %>" method="post">
                <input type="hidden" name="query_status" value="rejected">
                <button>Reject</button>
              </form>
            </li>
          <% end %>
        </ul>
      <% end %>

      <dt>Following</dt>
      <dd><%= @this_user.following.count %></dd>
    </dl>

    <nav>
      <ul>
        <li><a href="/users/<%= @this_user.username %>">Profile</a></li>
        <li><a href="/users/<%= @this_user.username %>/liked_photos">Liked photos</a></li>
        <li><a href="/users/<%= @this_user.username %>/feed">Feed</a></li>
        <li><a href="/users/<%= @this_user.username %>/discover">Discover</a></li>
      </ul>
    </nav>

    <h2>Own photos (<%= @this_user.photos.count %>)</h2>

    <table border="1">
      <tr>
        <th>Image</th>
        <th>Owner</th>
        <th>Caption</th>
        <th>Posted</th>
        <th>Likes</th>
        <th></th>
      </tr>
      <% @this_user.photos.each do |photo| %>
        <tr>
          <td><img src="<%= photo.image %>" class="img-responsive"></td>
          <td><%= photo.owner.username %></td>
          <td><%= photo.caption %></td>
          <td><%= time_ago_in_words(photo.created_at) %> ago</td>
          <td><%= photo.likes.count %></td>
          <td><a href="/photos/<%= photo.id %>">Show details</a></td>
        </tr>
      <% end %>
    </table>

  </body>
</html>
